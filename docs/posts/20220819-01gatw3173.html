<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Zig + Dart（FFI &#47; Wasm）の可能性 | Kabolog</title><link rel="canonical" href="https://blog.kaboc.cc/posts/20220819-01gatw3173"><link rel="author" href="http://www.hatena.ne.jp/kabochapo/"><link rel="shortcut icon" href="../favicon.ico"><link rel="icon" type="image/png" href="../res/images/android-chrome-192x192.png"><link rel="apple-touch-icon" href="../res/images/apple-touch-icon.png"><link rel="stylesheet" href="../res/css/styles.css?202305081040"><link rel="preload" href="../res/css/github-markdown-light.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><link rel="preload" href="../res/css/obsidian.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><meta name="title" content="Zig + Dart（FFI &#47; Wasm）の可能性 | Kabolog"><meta name="description" content="Dart で他の言語を利用するのは Go で試みたことがあります。 gomobile で作ったライブラリ + Flutter の Platform Channel アプリ開発にgomobileを利用する（Android&#47;iOS&#47;Flutter） - Qiita Go で作ったライブラリ + Dart FFI kaboc&#47;dart-ffi_cgo_ojicha"><meta name="keywords" content="Zig,Dart,FFI"><meta name="author" content="kaboc"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kaboc.cc/posts/20220819-01gatw3173"><meta property="og:image" content="https://blog.kaboc.cc/res/images/og-1200x630.jpg"><meta property="og:site_name" content="Kabolog"><meta property="og:title" content="Zig + Dart（FFI &#47; Wasm）の可能性 | Kabolog"><meta property="og:description" content="Dart で他の言語を利用するのは Go で試みたことがあります。 gomobile で作ったライブラリ + Flutter の Platform Channel アプリ開発にgomobileを利用する（Android&#47;iOS&#47;Flutter） - Qiita Go で作ったライブラリ + Dart FFI kaboc&#47;dart-ffi_cgo_ojicha"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.kaboc.cc/res/images/og-square.jpg"><meta name="twitter:site" content="@kabochapo"><meta name="twitter:creator" content="@kabochapo"><script defer src="../res/js/highlight.min.js"></script><script>window.onload = () => hljs.highlightAll();</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-8T92E4QR06"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-8T92E4QR06');
</script></head><body><div id="blog-view"><header><p><span><a href="../">Kabolog</a></span><span id="top-social-buttons"><a href="https://kaboc.cc/"><img src="../res/images/home.svg" alt="Home" width="20" height="20"></a><a href="https://twitter.com/kabochapo" target="_blank" rel="noopener"><img src="../res/images/brand-twitter.svg" alt="Twitter" width="20" height="20"></a><a href="https://github.com/kaboc" target="_blank" rel="noopener"><img src="../res/images/brand-github.svg" alt="GitHub" width="20" height="20"></a></span></p></header><div id="view-content"><main><h1 id="post-title">Zig + Dart（FFI &#47; Wasm）の可能性</h1><section id="post-meta"><ul id="category-list"><li><a href="../?c=Zig">Zig</a></li><li><a href="../?c=Dart%3A%3AFFI">Dart &gt; FFI</a></li></ul><time datetime="2022-08-19T10:58:55.976386Z">2022-08-19</time></section><article class="markdown-body"><p>Dart で他の言語を利用するのは Go で試みたことがあります。</p>
<ul>
<li>gomobile で作ったライブラリ + Flutter の Platform Channel
<ul>
<li><a href="https://qiita.com/kabochapo/items/b37c03ea9d30572fbd59" target="_blank" rel="noopener">アプリ開発にgomobileを利用する（Android/iOS/Flutter） - Qiita</a></li>
</ul>
</li>
<li>Go で作ったライブラリ + Dart FFI
<ul>
<li><a href="https://github.com/kaboc/dart-ffi_cgo_ojichat" target="_blank" rel="noopener">kaboc/dart-ffi_cgo_ojichat: A dart:ffi sample to use a shared library generated by cgo</a></li>
</ul>
</li>
</ul>
<p>今回は Zig です。<br>
いつかあるかもしれない実用の機会を視野に入れつつも、ほとんど興味本位です。</p>
<h1 id="%E3%81%84%E3%81%8F%E3%81%A4%E3%81%8B%E3%81%AE%E8%A8%80%E8%AA%9E%E3%81%AE%20Pros%20%2F%20Cons">いくつかの言語の Pros / Cons</h1>
<p>Dart で組み合わせて使うときの観点で挙げます。</p>
<h2 id="Go">Go</h2>
<ul>
<li>Pros
<ul>
<li>クロスコンパイルできる</li>
<li>標準パッケージが充実していてそれらを活用できる</li>
</ul>
</li>
<li>Cons
<ul>
<li>ライブラリのサイズが小さくても数 MB になる
<ul>
<li>モバイルアプリではサイズが大きく増えるのは避けたい</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Rust">Rust</h2>
<ul>
<li>Pros
<ul>
<li>Go より速い、小さい</li>
<li>堅牢</li>
<li>利用の実例がある
<ul>
<li><a href="https://pub.dev/packages/isar" target="_blank" rel="noopener">Isar</a></li>
</ul>
</li>
</ul>
</li>
<li>Cons
<ul>
<li>クロスコンパイルが簡単ではなさそう</li>
<li>学習コストが高くて手をつけにくい</li>
</ul>
</li>
</ul>
<h2 id="Zig">Zig</h2>
<p>参考: <a href="https://zenn.dev/hastur/articles/bacbe2af2c5807" target="_blank" rel="noopener">ざっくりとしたZigの紹介</a></p>
<ul>
<li>Pros
<ul>
<li>Go より速い、小さい</li>
<li>クロスコンパイルできるし、C のコンパイラとしても使える</li>
<li>覚えることが少ない</li>
</ul>
</li>
<li>Cons
<ul>
<li>標準ライブラリが貧弱</li>
<li>言語仕様も貧弱と捉える人がいそう
<ul>
<li>私は好感を持ったが、機能が充実した言語から始めた人にはたぶん辛い</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Dart での利用において、Zig の Pros として挙げた点が有利になると思いました。</p>
<h1 id="Zig%20%E3%81%A7%E3%83%93%E3%83%AB%E3%83%89">Zig でビルド</h1>
<p><a href="https://ziglearn.org/chapter-1/#functions" target="_blank" rel="noopener">ziglearn.org</a> のフィボナッチ数の関数に <code>export</code> を付けて使います。<br>
<code>u16</code> はまずいので後で変えます。</p>
<pre><code>export fn fibonacci(n: u16) u16 {  
    if (n == 0 or n == 1) return n;  
    return fibonacci(n - 1) + fibonacci(n - 2);  
}  
</code></pre>
<p>ソースコードは <code>src/main.zig</code> というパスになっているとします。</p>
<h2 id="%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%92%E7%94%9F%E6%88%90">ライブラリを生成</h2>
<p><a href="https://ziglang.org/documentation/master/#Exporting-a-C-Library" target="_blank" rel="noopener">https://ziglang.org/documentation/master/#Exporting-a-C-Library</a></p>
<pre><code class="language-shell">zig build-lib src/main.zig -dynamic --name fibonacci -O ReleaseSmall  
</code></pre>
<p>これだけでライブラリが生成されます。<br>
Windows では DLL です。<br>
これを後で Dart FFI で利用します。</p>
<h3 id="%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B5%E3%82%A4%E3%82%BA">ファイルサイズ</h3>
<p>出来上がった DLL ファイルは 4.5 KB でした。<br>
<code>-O</code> の最適化のフラグを指定しないと数百 KB になり、動作速度も遅くなります。</p>
<h3 id="%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB">クロスコンパイル</h3>
<p>ターゲットを <code>-target</code> で指定するだけでできます。<br>
https://ziglang.org/learn/overview/#cross-compiling-is-a-first-class-use-case</p>
<p>試しに Windows 上で <code>-target x86_64-linux-gnu</code> を付けてビルドすると <code>libfibonacci.so</code> が作られ、ファイルサイズは DLL より大きめの 47.9 KB になりました。</p>
<h2 id="Wasm%20%E3%82%92%E7%94%9F%E6%88%90">Wasm を生成</h2>
<p>Dart では <a href="https://pub.dev/packages/wasm" target="_blank" rel="noopener">package:wasm</a> を使って Wasm のファイルを読み込んで利用することができます。<br>
experimental ですが、興味深くて期待できるので試すことにしました。</p>
<p>パッケージは最初のバージョンである 0.1.0+1 が一年ほど前に出てから更新されていません。<br>
GitHub のそのリポジトリでは多少の動きはあるようです。</p>
<pre><code class="language-shell">zig build-lib src/main.zig -dynamic --name fibonacci -O ReleaseSmall -target wasm32-freestanding  
</code></pre>
<p>クロスコンパイルと同じ要領で <code>-target wasm32-freestanding</code> を指定するだけです。<br>
https://ziglang.org/documentation/master/#Freestanding</p>
<p>ファイルサイズは DLL とほぼ同じでした。</p>
<p>wasm ファイルはプラットフォームが違っても共通なのでクロスコンパイルが不要で、Dart で使うときに分岐しなくていいので扱いやすいです。</p>
<h1 id="Dart%20%E3%81%A7%E5%88%A9%E7%94%A8">Dart で利用</h1>
<p>ライブラリと Wasm をそれぞれ Dart で使ってみます。<br>
作った順序と逆に Wasm のほうから。</p>
<h2 id="Wasm">Wasm</h2>
<h3 id="%E6%BA%96%E5%82%99">準備</h3>
<h4 id="%E3%83%84%E3%83%BC%E3%83%AB">ツール</h4>
<p>package:wasm では WebAssembly のランタイムである Wasmer が用いられます。<br>
そのために Rust が使われるので、開発マシンに入っていなければインストールが必要です。</p>
<details>  
<summary>Windows の場合</summary>
<p>Windows では <code>link.exe</code> が使えるように Visual Studio の Build Tools で 「C++ によるデスクトップ開発」のインストールも必要とのことです。<br>
Flutter のデスクトップアプリを Windows 上で開発している人はインストール済みだと思います。</p>
<p>私の場合、それはインストール済みでしたが LLVM / Clang  がなかったので、Visual Studio Installer の「個別のコンポーネント」のところで「C++ Clang-cl」と「Windows 用 C++ Clang コンパイラ」をインストールし、さらに Path を設定しました。</p>
</details>
<h4 id="%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88">プロジェクト</h4>
<p>ドキュメントに従い、pubspec.yaml への wasm パッケージの追加などを行います。<br>
<code>dart run wasm:setup</code> ではプロジェクト内の <code> .dart_tools/wasm/</code> に Wasmer のライブラリが生成されます。</p>
<h3 id="%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF">読み込み</h3>
<p>wasm ファイルをソースコードと同じ場所に置いている場合は次のようになります。<br>
<code>windows</code> の引数は Windows 以外では指定しないか <code>false</code> で。</p>
<pre><code class="language-dart">import 'dart:io';  
import 'package:wasm/wasm.dart';  
  
void main() {  
  final path = Platform.script.resolve('fibonacci.wasm').toFilePath(windows: true);  
  final data = File(path).readAsBytesSync();  
  final mod = WasmModule(data);  
  print(mod.describe());  
}  
</code></pre>
<p><a href="https://pub.dev/documentation/wasm/latest/wasm/WasmModule-class.html" target="_blank" rel="noopener">WasmModule()</a> では、コンパイル済みの Wasm のバイナリを使って module のオブジェクトが組み立てられるそうです。<br>
そのオブジェクトの import / export の情報を <a href="https://pub.dev/documentation/wasm/latest/wasm/WasmModule/describe.html" target="_blank" rel="noopener">describe()</a> で得ることができるようになっています。<br>
上のコードではそれを print するようにしているので、実行すると次のように出力されます。</p>
<pre><code>export memory: memory  
export function: int32 fibonacci(int32)  
</code></pre>
<p>Zig のソースコードでは <code>u16</code> だったのに、この情報では <code>int32</code> になっています。<br>
このままフィボナッチ数を求めたところ間違った結果が返ったので、桁が溢れたと思われます。<br>
<code>int32</code> に見えているだけで実際には <code>uint16</code> のようです。</p>
<p>Zig で <code>u64</code> か <code>i64</code> に直して wasm ファイルとライブラリの両方を生成し直しましょう。</p>
<h3 id="%E5%88%A9%E7%94%A8">利用</h3>
<p>Wasm を Dart で利用するのは、もうここまで準備ができていると簡単です。<br>
型の定義を自分で用意しないといけない FFI より扱いやすいです。</p>
<pre><code class="language-dart">// この関数を使って実行とかかった時間の出力を行うことにします  
void run(int Function() func) {  
  final sw = Stopwatch()..start();  
  final number = func();  
  final elapsed = (sw..stop()).elapsedMilliseconds;  
  print('[$elapsed ms] $number');  
}  
</code></pre>
<pre><code class="language-dart">final mod = WasmModule(data);  
final inst = mod.builder().build();  
final fibonacci = inst.lookupFunction('fibonacci');  
run(() =&gt; fibonacci(45)); // [8111 ms] 113490317  
</code></pre>
<h2 id="FFI">FFI</h2>
<p>以前には別の PC で <a href="https://pub.dev/packages/ffigen" target="_blank" rel="noopener">ffigen</a> を使ったのですが、今の自分の PC では何かが不足していて利用できなかったので、型の定義は手動で行いました。</p>
<pre><code class="language-dart">import 'dart:ffi' as ffi;  
import 'dart:io';  
  
typedef Fibonacci = int Function(int);  
typedef FibonacciFunc = ffi.Int Function(ffi.Int);  
  
void main() {  
  final path = Platform.script.resolve('fibonacci.dll').toFilePath(windows: true);  
  final lib = ffi.DynamicLibrary.open(path);  
  final fibonacci = lib  
      .lookup&lt;ffi.NativeFunction&lt;FibonacciFunc&gt;&gt;('fibonacci')  
      .asFunction&lt;Fibonacci&gt;();  
  
  run(() =&gt; fibonacci(45)); // [3944 ms] 1134903170  
}  
</code></pre>
<h2 id="Dart">Dart</h2>
<p>Dart 単体での速度も比較のために確認します。</p>
<pre><code class="language-dart">int fibonacci(int n) {  
  return n == 0 || n == 1 ? n : fibonacci(n - 1) + fibonacci(n - 2);  
}  
  
void main() {  
  run(() =&gt; fibonacci(45)); // [10138 ms] 1134903170  
}  
</code></pre>
<h1 id="%E7%B5%90%E6%9E%9C">結果</h1>
<table>
<thead>
<tr>
<th align="center">Wasm</th>
<th align="center">FFI</th>
<th align="center">Dart</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">8111 ms</td>
<td align="center">3944 ms</td>
<td align="center">10138 ms</td>
</tr>
</tbody>
</table>
<p>Zig + Dart FFI は使えそうですね。</p>
<p>Wasm はわざわざ利用する意味がありそうな圧倒的な速さではありませんでした。<br>
Wasm か Wasmer の限界なのでしょうか。<br>
扱いやすさでは勝っていただけに残念に思います。<br>
Dart が苦手とする処理が何かあるなら、そこでは Wasm でも効果的かもしれません。</p>
</article><section id="bottom-social-buttons"><a href="https://twitter.com/share?url=https%3A%2F%2Fblog.kaboc.cc%2Fposts%2F20220819-01gatw3173&amp;text=Zig%20%2B%20Dart%EF%BC%88FFI%20%2F%20Wasm%EF%BC%89%E3%81%AE%E5%8F%AF%E8%83%BD%E6%80%A7%20%7C%20Kabolog&amp;via=kabochapo" title="ツイートする" target="_blank" rel="noopener"><img src="../res/images/twitter-button.svg" alt="ツイートする" width="40" height="40"></a><a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="touch" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="40" height="40" style="border: none;"></a><script async src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8"></script></section></main></div><footer><p><a href="../">Kabolog</a></p><small>&copy; 2022 <a href="https://kaboc.cc/">kaboc</a></small></footer></div></body></html>